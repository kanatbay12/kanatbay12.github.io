<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å | AutoDiag Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@700;800&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- –°–µ–∫—Ü–∏—è –≤—Ö–æ–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞ -->
    <div id="admin-login-section" class="container">
        <form id="admin-login-form" class="form-container">
            <h1>–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            <p id="admin-login-error" class="error-message hidden"></p>
            <div class="form-group">
                <input type="email" id="admin-login-email" placeholder="Email" required>
            </div>
            <div class="form-group">
                <input type="password" id="admin-login-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
            </div>
            <button type="submit" class="btn" style="width: 100%;">–í–æ–π—Ç–∏</button>
        </form>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (—Å–∫—Ä—ã—Ç–∞ –¥–æ –≤—Ö–æ–¥–∞) -->
    <div id="admin-panel-section" class="container hidden">
        <div class="admin-panel-header">
            <h1 id="admin-panel-title">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
            <button id="admin-logout-btn" class="btn btn-outline">–í—ã–π—Ç–∏</button>
        </div>
        
        <!-- View –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–∞–º–∏ -->
        <div id="admin-brands-view">
            <form id="admin-brand-form" class="form-container" style="max-width: none;">
                <h2 id="admin-brand-form-title">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫—É</h2>
                <input type="hidden" id="admin-brand-id">
                <div class="form-group"><label for="admin-brand-name">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä–∫–∏</label><input type="text" id="admin-brand-name" required></div>
                <div class="form-group"><label for="admin-brand-continent">–ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç</label><select id="admin-brand-continent" required><option value="europe">–ï–≤—Ä–æ–ø–∞</option><option value="asia">–ê–∑–∏—è</option><option value="america">–ê–º–µ—Ä–∏–∫–∞</option></select></div>
                <div class="form-group"><label for="admin-brand-country">–ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã (2 –±—É–∫–≤—ã, en)</label><input type="text" id="admin-brand-country" required maxlength="2" style="text-transform: lowercase;"></div>
                <button type="submit" class="btn" id="admin-brand-submit-btn">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫—É</button>
                <button type="button" class="btn btn-outline" id="admin-brand-cancel-btn" style="display:none;">–û—Ç–º–µ–Ω–∞</button>
            </form>
            <div class="admin-brands-list" id="admin-brands-list"></div>
        </div>

        <!-- View –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–µ–ª—è–º–∏ -->
        <div id="admin-models-view" class="hidden">
            <button id="back-to-brands-btn" class="btn btn-outline" style="margin-bottom: 1rem;">‚Üê –ù–∞–∑–∞–¥ –∫ –º–∞—Ä–∫–∞–º</button>
            <form id="admin-model-form" class="form-container" style="max-width: none;">
                <h2 id="admin-model-form-title">–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å</h2>
                <input type="hidden" id="admin-model-id">
                <div class="form-group"><label for="admin-model-name">–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏</label><input type="text" id="admin-model-name" required></div>
                <div class="form-group"><label for="admin-model-years">–ì–æ–¥—ã –≤—ã–ø—É—Å–∫–∞</label><input type="text" id="admin-model-years"></div>
                <div class="form-group"><label for="admin-model-engine">–î–≤–∏–≥–∞—Ç–µ–ª–∏</label><textarea id="admin-model-engine" rows="3"></textarea></div>
                <div class="form-group"><label for="admin-model-issues">–¢–∏–ø–æ–≤—ã–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏</label><textarea id="admin-model-issues" rows="3"></textarea></div>
                <button type="submit" class="btn" id="admin-model-submit-btn">–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å</button>
                <button type="button" class="btn btn-outline" id="admin-model-cancel-btn" style="display:none;">–û—Ç–º–µ–Ω–∞</button>
            </form>
            <div class="admin-brands-list" id="admin-models-list"></div>
        </div>
    </div>

    <script type="module" src="scripts/config.js"></script>
    <script>import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

        // ===============================================================
        // UID –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê
        // –ó–∞–º–µ–Ω–∏—Ç–µ "YOUR_ADMIN_UID" –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π UID –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
        // –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ Firebase Authentication
        // ===============================================================
        const adminUid = "9B9EWaCLoWOq8J8f8vrmP6Yx4vs1";

        const firebaseConfig = {
          apiKey: "AIzaSyBK7irH8u4HNgcnxAusGNzj7WHzJj0ka_M",
          authDomain: "autodiag-kana.firebaseapp.com",
          projectId: "autodiag-kana",
          storageBucket: "autodiag-kana.firebasestorage.app",
          messagingSenderId: "643930483001",
          appId: "1:643930483001:web:be4621c52f342abc73a0e8"
        };

// –≠–ª–µ–º–µ–Ω—Ç—ã UI
const ui = {
    loginSection: document.getElementById('admin-login-section'),
    panelSection: document.getElementById('admin-panel-section'),
    loginForm: document.getElementById('admin-login-form'),
    loginError: document.getElementById('admin-login-error'),
    logoutBtn: document.getElementById('admin-logout-btn'),
    panelTitle: document.getElementById('admin-panel-title'),
    // Brands
    brandsView: document.getElementById('admin-brands-view'),
    brandForm: document.getElementById('admin-brand-form'),
    brandsList: document.getElementById('admin-brands-list'),
    brandFormTitle: document.getElementById('admin-brand-form-title'),
    brandSubmitBtn: document.getElementById('admin-brand-submit-btn'),
    brandCancelBtn: document.getElementById('admin-brand-cancel-btn'),
    brandIdField: document.getElementById('admin-brand-id'),
    // Models
    modelsView: document.getElementById('admin-models-view'),
    backToBrandsBtn: document.getElementById('back-to-brands-btn'),
    modelForm: document.getElementById('admin-model-form'),
    modelsList: document.getElementById('admin-models-list'),
    modelFormTitle: document.getElementById('admin-model-form-title'),
    modelSubmitBtn: document.getElementById('admin-model-submit-btn'),
    modelCancelBtn: document.getElementById('admin-model-cancel-btn'),
    modelIdField: document.getElementById('admin-model-id'),
};

let masterBrandList = [];
let selectedBrandForModels = null;
let unsubscribeModels = null; // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø–∏—Å–∫–∏ –æ—Ç —Å–ª—É—à–∞—Ç–µ–ª—è –º–æ–¥–µ–ª–µ–π

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
onAuthStateChanged(auth, user => {
    if (user && user.uid === adminUid) {
        ui.loginSection.classList.add('hidden');
        ui.panelSection.classList.remove('hidden');
        setupAdminPanelListeners();
    } else {
        ui.loginSection.classList.remove('hidden');
        ui.panelSection.classList.add('hidden');
    }
});

// –í—Ö–æ–¥ –∏ –≤—ã—Ö–æ–¥
ui.loginForm.addEventListener('submit', (e) => { e.preventDefault(); const email = ui.loginForm.querySelector('input[type="email"]').value; const password = ui.loginForm.querySelector('input[type="password"]').value; ui.loginError.classList.add('hidden'); signInWithEmailAndPassword(auth, email, password).catch(error => { ui.loginError.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å."; ui.loginError.classList.remove('hidden'); }); });
ui.logoutBtn.addEventListener('click', () => signOut(auth));

function setupAdminPanelListeners() {
    onSnapshot(collection(db, "brands"), (snapshot) => {
        masterBrandList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderAdminBrandsList();
    });

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–∞–º–∏
    ui.brandForm.addEventListener('submit', async (e) => { e.preventDefault(); const id = ui.brandIdField.value; const data = { name: document.getElementById('admin-brand-name').value, continent: document.getElementById('admin-brand-continent').value, country: document.getElementById('admin-brand-country').value.toLowerCase() }; try { if (id) { await updateDoc(doc(db, 'brands', id), data); } else { await addDoc(collection(db, 'brands'), data); } resetBrandForm(); } catch (error) { console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ä–∫–∏:", error); } });
    ui.brandsList.addEventListener('click', (e) => { const target = e.target.closest('button'); if (!target) return; const id = target.dataset.id; if (target.classList.contains('edit-btn')) { const brand = masterBrandList.find(b => b.id === id); ui.brandIdField.value = brand.id; document.getElementById('admin-brand-name').value = brand.name; document.getElementById('admin-brand-continent').value = brand.continent; document.getElementById('admin-brand-country').value = brand.country; ui.brandFormTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä–∫—É'; ui.brandSubmitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; ui.brandCancelBtn.style.display = 'inline-block'; } if (target.classList.contains('delete-btn')) { if (confirm('–£–¥–∞–ª–∏—Ç—å –º–∞—Ä–∫—É –∏ –≤—Å–µ –µ–µ –º–æ–¥–µ–ª–∏?')) { deleteDoc(doc(db, 'brands', id)); } } if (target.classList.contains('models-btn')) { selectedBrandForModels = masterBrandList.find(b => b.id === id); showModelsView(); } });
    ui.brandCancelBtn.addEventListener('click', resetBrandForm);

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏
    ui.backToBrandsBtn.addEventListener('click', showBrandsView);
    ui.modelForm.addEventListener('submit', async (e) => { e.preventDefault(); const id = ui.modelIdField.value; const data = { name: document.getElementById('admin-model-name').value, years: document.getElementById('admin-model-years').value, engine: document.getElementById('admin-model-engine').value, issues: document.getElementById('admin-model-issues').value, }; try { const collectionRef = collection(db, `brands/${selectedBrandForModels.id}/models`); if (id) { await updateDoc(doc(collectionRef, id), data); } else { await addDoc(collectionRef, data); } resetModelForm(); } catch (error) { console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–∏:", error); } });
    ui.modelsList.addEventListener('click', (e) => { const target = e.target.closest('button'); if (!target) return; const id = target.dataset.id; if (target.classList.contains('edit-btn')) { const model = JSON.parse(target.dataset.model); ui.modelIdField.value = id; document.getElementById('admin-model-name').value = model.name; document.getElementById('admin-model-years').value = model.years; document.getElementById('admin-model-engine').value = model.engine; document.getElementById('admin-model-issues').value = model.issues; ui.modelFormTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å'; ui.modelSubmitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; ui.modelCancelBtn.style.display = 'inline-block'; } if (target.classList.contains('delete-btn')) { if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–æ–¥–µ–ª—å?')) { deleteDoc(doc(db, `brands/${selectedBrandForModels.id}/models`, id)); } } });
    ui.modelCancelBtn.addEventListener('click', resetModelForm);
}

function renderAdminBrandsList() {
    ui.brandsList.innerHTML = '';
    [...masterBrandList].sort((a,b) => a.name.localeCompare(b.name)).forEach(brand => {
        const item = document.createElement('div');
        item.className = 'admin-brand-item';
        item.innerHTML = `<div class="admin-brand-info"><span><strong>${brand.name}</strong></span><span>${brand.continent}</span><span>${brand.country}</span></div><div class="admin-brand-actions"><button class="models-btn" data-id="${brand.id}" title="–ú–æ–¥–µ–ª–∏">‚öôÔ∏è</button><button class="edit-btn" data-id="${brand.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button><button class="delete-btn" data-id="${brand.id}" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button></div>`;
        ui.brandsList.appendChild(item);
    });
}

function showBrandsView() {
    ui.brandsView.classList.remove('hidden');
    ui.modelsView.classList.add('hidden');
    ui.panelTitle.textContent = '–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–∞–º–∏';
    if (unsubscribeModels) unsubscribeModels();
}

function showModelsView() {
    ui.brandsView.classList.add('hidden');
    ui.modelsView.classList.remove('hidden');
    ui.panelTitle.textContent = `–ú–æ–¥–µ–ª–∏ –¥–ª—è: ${selectedBrandForModels.name}`;
    resetModelForm();
    
    const modelsRef = collection(db, `brands/${selectedBrandForModels.id}/models`);
    unsubscribeModels = onSnapshot(modelsRef, (snapshot) => {
        ui.modelsList.innerHTML = '';
        snapshot.docs.sort((a,b) => a.data().name.localeCompare(b.data().name)).forEach(doc => {
            const model = { id: doc.id, ...doc.data() };
            const item = document.createElement('div');
            item.className = 'admin-brand-item';
            item.innerHTML = `<div class="admin-brand-info"><span><strong>${model.name}</strong></span></div><div class="admin-brand-actions"><button class="edit-btn" data-id="${model.id}" data-model='${JSON.stringify(model)}' title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button><button class="delete-btn" data-id="${model.id}" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button></div>`;
            ui.modelsList.appendChild(item);
        });
    });
}

function resetBrandForm() { ui.brandForm.reset(); ui.brandIdField.value = ''; ui.brandFormTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –º–∞—Ä–∫—É'; ui.brandSubmitBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫—É'; ui.brandCancelBtn.style.display = 'none'; }
function resetModelForm() { ui.modelForm.reset(); ui.modelIdField.value = ''; ui.modelFormTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å'; ui.modelSubmitBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å'; ui.modelCancelBtn.style.display = 'none'; }
</script>
</body>
</html>
