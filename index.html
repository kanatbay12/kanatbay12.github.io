<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Система записи на сервис</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #111827;
        color: #f3f4f6;
      }
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }
      .form-input {
        background-color: #374151;
        border: 1px solid #4b5563;
        color: #f3f4f6;
        border-radius: 0.5rem;
      }
      .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px #1e40af;
      }
      .form-input:disabled {
        background-color: #4b5563;
        cursor: not-allowed;
      }
      .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        border: none;
      }
      .btn-primary {
        background-color: #3b82f6;
        color: white;
      }
      .btn-primary:hover {
        background-color: #2563eb;
      }
      .btn-secondary {
        background-color: #4b5563;
        color: white;
      }
      .btn-secondary:hover {
        background-color: #6b7280;
      }
      .btn-danger {
        background-color: #ef4444;
        color: white;
      }
      .btn-danger:hover {
        background-color: #dc2626;
      }
      .btn-success {
        background-color: #10b981;
        color: white;
      }
      .btn-warning {
        background-color: #f59e0b;
        color: white;
      }

      /* Стили для сетки */
      .schedule-grid {
        display: grid;
        grid-template-columns: 6rem repeat(4, 1fr); /* Время + 4 сотрудника */
        gap: 4px;
      }
      .grid-header {
        position: sticky;
        top: 0;
        background-color: #1f2937;
        z-index: 10;
      }
      .time-cell {
        grid-column: 1 / 2;
      }
      .employee-cell {
        min-height: 80px;
        transition: background-color 0.3s ease;
      }

      /* Стили для окраски карточек записей */
      .cell-scheduled {
        background-color: #1e3a8a; /* Синий */
        border: 1px solid #3b82f6;
      }
      .cell-in-progress {
        background-color: #92400e; /* Желтый/Янтарный */
        border: 1px solid #f59e0b;
      }
      .cell-completed {
        background-color: #065f46; /* Зеленый */
        border: 1px solid #10b981;
      }
      .cell-cancelled {
        background-color: #991b1b; /* Красный */
        border: 1px solid #ef4444;
      }
    </style>
  </head>
  <body>
    <div class="container mx-auto p-4 md:p-8">
      <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-white">Система записи на сервисное обслуживание</h1>
        <p class="text-gray-400 mt-2">Добавляйте и управляйте записями клиентов в реальном времени.</p>
        <div class="mt-4 text-sm text-gray-500">
          Ваш ID пользователя: <span id="userId" class="font-mono bg-gray-700 px-2 py-1 rounded">Загрузка...</span>
        </div>
      </header>

      <!-- Форма для добавления записи -->
      <div id="booking-form-container" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-white">Новая запись</h2>
        <form id="booking-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div>
            <label for="customerName" class="block text-sm font-medium text-gray-300 mb-1">Имя клиента</label>
            <input type="text" id="customerName" class="w-full form-input p-2" required />
          </div>
          <div>
            <label for="customerPhone" class="block text-sm font-medium text-gray-300 mb-1">Телефон клиента</label>
            <input type="tel" id="customerPhone" class="w-full form-input p-2" required />
          </div>
          <div>
            <label for="serviceType" class="block text-sm font-medium text-gray-300 mb-1">Тип услуги</label>
            <select id="serviceType" class="w-full form-input p-2">
              <option>Техническое обслуживание (ТО)</option>
              <option>Диагностика</option>
              <option>Ремонт двигателя</option>
              <option>Ремонт ходовой части</option>
              <option>Шиномонтаж</option>
              <option>Другое</option>
            </select>
          </div>
          <div>
            <label for="carBrand" class="block text-sm font-medium text-gray-300 mb-1">Марка автомобиля</label>
            <select id="carBrand" class="w-full form-input p-2" required></select>
          </div>
          <div>
            <label for="carModel" class="block text-sm font-medium text-gray-300 mb-1">Модель автомобиля</label>
            <select id="carModel" class="w-full form-input p-2" required disabled>
              <option value="">Сначала выберите марку</option>
            </select>
          </div>
          <div>
            <label for="appointmentDate" class="block text-sm font-medium text-gray-300 mb-1">Дата записи</label>
            <input type="date" id="appointmentDate" class="w-full form-input p-2" required />
          </div>
          <div>
            <label for="appointmentTime" class="block text-sm font-medium text-gray-300 mb-1">Время записи</label>
            <select id="appointmentTime" class="w-full form-input p-2" required>
              <!-- Опции будут добавлены с помощью JS -->
            </select>
          </div>
          <div>
            <label for="appointmentDuration" class="block text-sm font-medium text-gray-300 mb-1"
              >Длительность (часы)</label
            >
            <input
              type="number"
              id="appointmentDuration"
              class="w-full form-input p-2"
              value="1"
              min="1"
              max="8"
              required
            />
          </div>
          <div>
            <label for="employee" class="block text-sm font-medium text-gray-300 mb-1">Сотрудник</label>
            <select id="employee" class="w-full form-input p-2">
              <option>Алексей Петров</option>
              <option>Иван Сидоров</option>
              <option>Сергей Иванов</option>
              <option>Мария Кузнецова</option>
            </select>
          </div>
          <div class="lg:col-span-3">
            <button type="submit" class="btn btn-primary w-full lg:w-auto">Записать клиента</button>
            <p id="form-error" class="text-red-400 text-sm mt-2 hidden"></p>
          </div>
        </form>
      </div>

      <!-- Ежедневник -->
      <div id="schedule-container" class="bg-gray-800 p-6 rounded-lg shadow-lg">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
          <h2 class="text-2xl font-semibold text-white">План на день</h2>
          <div>
            <label for="scheduleDate" class="text-sm font-medium text-gray-300 mr-2">Выберите дату:</label>
            <input type="date" id="scheduleDate" class="form-input p-2" />
          </div>
        </div>
        <div id="daily-schedule-grid-container" class="overflow-x-auto">
          <div id="daily-schedule-grid" class="schedule-grid">
            <!-- Сетка ежедневника будет сгенерирована здесь -->
          </div>
        </div>
      </div>
    </div>

    <!-- Модальное окно для подтверждения -->
    <div id="confirmation-modal" class="modal-backdrop hidden">
      <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
        <h3 class="text-lg font-bold text-white mb-4" id="modal-title">Подтвердите действие</h3>
        <p class="text-gray-300 mb-6" id="modal-body">Вы уверены?</p>
        <div class="flex justify-end space-x-4">
          <button id="modal-cancel-btn" class="btn btn-secondary">Отмена</button>
          <button id="modal-confirm-btn" class="btn">Подтвердить</button>
        </div>
      </div>
    </div>

    <script type="module">
      <script type="module">
    // Ожидаем, пока вся HTML-структура страницы будет загружена
    document.addEventListener('DOMContentLoaded', () => {
        // Импорты Firebase
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
        const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
        const { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, setLogLevel } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

        setLogLevel('debug');

        // --- ВАЖНО: Вставьте сюда вашу конфигурацию из Firebase ---
        // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBGAuZan6tfRXlzyJ3vxAEd9NA3m43xPos",
  authDomain: "registration-a70d6.firebaseapp.com",
  projectId: "registration-a70d6",
  storageBucket: "registration-a70d6.firebasestorage.app",
  messagingSenderId: "662670826790",
  appId: "1:662670826790:web:5b85a49c6ee618140ef5e7",
  measurementId: "G-QV8HBNH7XQ"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
        // ---------------------------------------------------------

        const appId = 'service-booking-default';
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Все DOM элементы
        const bookingForm = document.getElementById('booking-form');
        const userIdSpan = document.getElementById('userId');
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const scheduleDateInput = document.getElementById('scheduleDate');
        const dailyScheduleGrid = document.getElementById('daily-schedule-grid');
        const appointmentDateInput = document.getElementById('appointmentDate');
        const appointmentTimeInput = document.getElementById('appointmentTime');
        const appointmentDurationInput = document.getElementById('appointmentDuration');
        const employeeSelect = document.getElementById('employee');
        const carBrandSelect = document.getElementById('carBrand');
        const carModelSelect = document.getElementById('carModel');
        const formError = document.getElementById('form-error');

        // Глобальные переменные
        let currentUser = null;
        let currentUserId = null;
        let allAppointments = [];
        let selectedDate = new Date().toISOString().split('T')[0];
        const employees = Array.from(employeeSelect.options).map(opt => opt.value);

        const WORK_DAY_START_HOUR = 9;
        const WORK_DAY_END_HOUR = 20;

        const carData = {
            'KIA': ['Rio', 'Ceed', 'Sportage', 'K5', 'Seltos'],
            'Chevrolet': ['Cobalt', 'Nexia', 'Spark', 'Damas', 'Onix'],
            'JAC': ['J7', 'JS4', 'S3', 'T6'],
            'Jetour': ['X70 Plus', 'X90 Plus', 'Dashing', 'T2']
        };

        // Все функции остаются без изменений...
        // ... (здесь должен быть весь остальной JS-код из предыдущей версии) ...

        // Просто скопируйте все функции отсюда и до конца скрипта из предыдущего файла
        
        // --- ЗАПУСК ПРИЛОЖЕНИЯ ---
        initializeUI();
        signIn();
    });
</script>
    </script>
  </body>
</html>
