<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Система записи на сервис</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <!-- Загрузка библиотек Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #111827;
        color: #f3f4f6;
      }
      .modal-backdrop,
      #config-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        backdrop-filter: blur(4px);
      }
      .form-input {
        background-color: #374151;
        border: 1px solid #4b5563;
        color: #f3f4f6;
        border-radius: 0.5rem;
      }
      .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px #1e40af;
      }
      .form-input:disabled {
        background-color: #4b5563;
        cursor: not-allowed;
      }
      .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        border: none;
      }
      .btn-primary {
        background-color: #3b82f6;
        color: white;
      }
      .btn-primary:hover {
        background-color: #2563eb;
      }
      .btn-secondary {
        background-color: #4b5563;
        color: white;
      }
      .btn-secondary:hover {
        background-color: #6b7280;
      }
      .btn-danger {
        background-color: #ef4444;
        color: white;
      }
      .btn-danger:hover {
        background-color: #dc2626;
      }
      .btn-success {
        background-color: #10b981;
        color: white;
      }
      .btn-warning {
        background-color: #f59e0b;
        color: white;
      }

      .schedule-grid {
        display: grid;
        grid-template-columns: 6rem repeat(4, 1fr);
        gap: 4px;
      }
      .grid-header {
        position: sticky;
        top: 0;
        background-color: #1f2937;
        z-index: 10;
      }
      .time-cell {
        grid-column: 1 / 2;
      }
      .employee-cell {
        min-height: 80px;
        transition: background-color 0.3s ease;
      }
      .cell-scheduled {
        background-color: #1e3a8a;
        border: 1px solid #3b82f6;
      }
      .cell-in-progress {
        background-color: #92400e;
        border: 1px solid #f59e0b;
      }
      .cell-completed {
        background-color: #065f46;
        border: 1px solid #10b981;
      }
      .cell-cancelled {
        background-color: #991b1b;
        border: 1px solid #ef4444;
      }
    </style>
  </head>
  <body>
    <!-- Оверлей для ошибки конфигурации -->
    <div id="config-overlay" class="hidden">
      <div class="bg-red-800 text-white p-8 rounded-lg shadow-2xl max-w-2xl mx-auto text-left">
        <h1 class="text-3xl font-bold mb-4">Ошибка: Приложение не настроено!</h1>
        <p class="mb-4 text-lg">Чтобы приложение заработало, вам нужно подключить его к вашей базе данных Firebase.</p>
        <p class="mb-2 font-semibold">Пожалуйста, выполните следующие шаги:</p>
        <ol class="list-decimal list-inside space-y-2 mb-6">
          <li>Откройте этот файл `index.html` в текстовом редакторе.</li>
          <li>
            Найдите в коде секцию с заголовком KANA
            <code class="bg-black/50 px-2 py-1 rounded-md">ВАЖНО: ШАГ 1 - НАСТРОЙКА FIREBASE</code>.
          </li>
          <li>
            Замените значения-заполнители (<code class="bg-black/50 px-2 py-1 rounded-md"
              >!!!_ВСТАВЬТЕ_ВАШ_КЛЮЧ_СЮДА_!!!</code
            >) на ваши реальные ключи из проекта Firebase.
          </li>
          <li>Сохраните файл и загрузите его на GitHub Pages снова.</li>
        </ol>
        <p class="text-sm text-red-200">
          Без этого шага приложение работать не будет, так как не знает, куда сохранять данные.
        </p>
      </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
      <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-white">Система записи на сервисное обслуживание</h1>
        <p class="text-gray-400 mt-2">Добавляйте и управляйте записями клиентов в реальном времени.</p>
        <div class="mt-4 text-sm text-gray-500">
          Ваш ID пользователя: <span id="userId" class="font-mono bg-gray-700 px-2 py-1 rounded">Загрузка...</span>
        </div>
      </header>

      <div id="booking-form-container" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-white">Новая запись</h2>
        <form id="booking-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div>
            <label for="customerName" class="block text-sm font-medium text-gray-300 mb-1">Имя клиента</label>
            <input type="text" id="customerName" class="w-full form-input p-2" required />
          </div>
          <div>
            <label for="customerPhone" class="block text-sm font-medium text-gray-300 mb-1">Телефон клиента</label>
            <input type="tel" id="customerPhone" class="w-full form-input p-2" required />
          </div>
          <div>
            <label for="serviceType" class="block text-sm font-medium text-gray-300 mb-1">Тип услуги</label>
            <select id="serviceType" class="w-full form-input p-2">
              <option>Техническое обслуживание (ТО)</option>
              <option>Диагностика</option>
              <option>Ремонт двигателя</option>
              <option>Ремонт ходовой части</option>
              <option>Шиномонтаж</option>
              <option>Другое</option>
            </select>
          </div>
          <div>
            <label for="carBrand" class="block text-sm font-medium text-gray-300 mb-1">Марка автомобиля</label>
            <select id="carBrand" class="w-full form-input p-2" required></select>
          </div>
          <div>
            <label for="carModel" class="block text-sm font-medium text-gray-300 mb-1">Модель автомобиля</label>
            <select id="carModel" class="w-full form-input p-2" required disabled>
              <option value="">Сначала выберите марку</option>
            </select>
          </div>
          <div>
            <label for="appointmentDate" class="block text-sm font-medium text-gray-300 mb-1">Дата записи</label>
            <input type="date" id="appointmentDate" class="w-full form-input p-2" required />
          </div>
          <div>
            <label for="appointmentTime" class="block text-sm font-medium text-gray-300 mb-1">Время записи</label>
            <select id="appointmentTime" class="w-full form-input p-2" required></select>
          </div>
          <div>
            <label for="appointmentDuration" class="block text-sm font-medium text-gray-300 mb-1"
              >Длительность (часы)</label
            >
            <input
              type="number"
              id="appointmentDuration"
              class="w-full form-input p-2"
              value="1"
              min="1"
              max="8"
              required
            />
          </div>
          <div>
            <label for="employee" class="block text-sm font-medium text-gray-300 mb-1">Сотрудник</label>
            <select id="employee" class="w-full form-input p-2">
              <option>Алексей Петров</option>
              <option>Иван Сидоров</option>
              <option>Сергей Иванов</option>
              <option>Мария Кузнецова</option>
            </select>
          </div>
          <div class="lg:col-span-3">
            <button type="submit" class="btn btn-primary w-full lg:w-auto">Записать клиента</button>
            <p id="form-error" class="text-red-400 text-sm mt-2 hidden"></p>
          </div>
        </form>
      </div>

      <div id="schedule-container" class="bg-gray-800 p-6 rounded-lg shadow-lg">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
          <h2 class="text-2xl font-semibold text-white">План на день</h2>
          <div>
            <label for="scheduleDate" class="text-sm font-medium text-gray-300 mr-2">Выберите дату:</label>
            <input type="date" id="scheduleDate" class="form-input p-2" />
          </div>
        </div>
        <div id="daily-schedule-grid-container" class="overflow-x-auto">
          <div id="daily-schedule-grid" class="schedule-grid"></div>
        </div>
      </div>
    </div>

    <div id="confirmation-modal" class="modal-backdrop hidden">
      <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
        <h3 class="text-lg font-bold text-white mb-4" id="modal-title">Подтвердите действие</h3>
        <p class="text-gray-300 mb-6" id="modal-body">Вы уверены?</p>
        <div class="flex justify-end space-x-4">
          <button id="modal-cancel-btn" class="btn btn-secondary">Отмена</button>
          <button id="modal-confirm-btn" class="btn">Подтвердить</button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // =====================================================================================
        // =========================== ВАЖНО: ШАГ 1 - НАСТРОЙКА FIREBASE ===========================
        // =====================================================================================
        //
        // ОШИБКА "SyntaxError" или "auth/api-key-not-valid" ОЗНАЧАЕТ,
        // ЧТО ВЫ НЕ ЗАМЕНИЛИ ДАННЫЕ НИЖЕ НА СВОИ СОБСТВЕННЫЕ КЛЮЧИ ИЗ FIREBASE.
        //
        // 1. Перейдите в ваш проект на https://console.firebase.google.com/
        // 2. Нажмите на иконку шестеренки (Настройки проекта).
        // 3. В разделе "Ваши приложения" найдите объект `firebaseConfig`.
        // 4. СКОПИРУЙТЕ ВАШИ КЛЮЧИ и ВСТАВЬТЕ их вместо текста-заполнителя ниже.
        //    Убедитесь, что кавычки "" вокруг ваших ключей остались на месте.
        //
        // =====================================================================================
        // Import the functions you need from the SDKs you need

        const firebaseConfig = {
          apiKey: "AIzaSyBGAuZan6tfRXlzyJ3vxAEd9NA3m43xPos",
          authDomain: "registration-a70d6.firebaseapp.com",
          projectId: "registration-a70d6",
          storageBucket: "registration-a70d6.firebasestorage.app",
          messagingSenderId: "662670826790",
          appId: "1:662670826790:web:5b85a49c6ee618140ef5e7",
          measurementId: "G-QV8HBNH7XQ",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        // Проверка на наличие демонстрационных ключей
        if (firebaseConfig.apiKey.startsWith("!!!_")) {
          document.getElementById("config-overlay").classList.remove("hidden");
          return; // Останавливаем выполнение скрипта
        }

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Все DOM элементы
        const bookingForm = document.getElementById("booking-form");
        const userIdSpan = document.getElementById("userId");
        const modal = document.getElementById("confirmation-modal");
        const modalTitle = document.getElementById("modal-title");
        const modalBody = document.getElementById("modal-body");
        const modalCancelBtn = document.getElementById("modal-cancel-btn");
        const modalConfirmBtn = document.getElementById("modal-confirm-btn");
        const scheduleDateInput = document.getElementById("scheduleDate");
        const dailyScheduleGrid = document.getElementById("daily-schedule-grid");
        const appointmentDateInput = document.getElementById("appointmentDate");
        const appointmentTimeInput = document.getElementById("appointmentTime");
        const appointmentDurationInput = document.getElementById("appointmentDuration");
        const employeeSelect = document.getElementById("employee");
        const carBrandSelect = document.getElementById("carBrand");
        const carModelSelect = document.getElementById("carModel");
        const formError = document.getElementById("form-error");

        let currentUser = null;
        let currentUserId = null;
        let allAppointments = [];
        let selectedDate = new Date().toISOString().split("T")[0];
        const employees = Array.from(employeeSelect.options).map((opt) => opt.value);

        const WORK_DAY_START_HOUR = 9;
        const WORK_DAY_END_HOUR = 20;
        const APPOINTMENTS_COLLECTION = "appointments";

        const carData = {
          KIA: ["Rio", "Ceed", "Sportage", "K5", "Seltos"],
          Chevrolet: ["Cobalt", "Nexia", "Spark", "Damas", "Onix"],
          JAC: ["J7", "JS4", "S3", "T6"],
          Jetour: ["X70 Plus", "X90 Plus", "Dashing", "T2"],
        };

        auth.onAuthStateChanged((user) => {
          if (user) {
            currentUser = user;
            currentUserId = user.uid;
            userIdSpan.textContent = currentUserId;
            listenForAppointments();
          } else {
            auth.signInAnonymously().catch((error) => {
              console.error("Ошибка анонимного входа:", error);
              userIdSpan.textContent = "Ошибка входа";
            });
          }
        });

        function populateTimeSelect() {
          appointmentTimeInput.innerHTML = "";
          for (let hour = WORK_DAY_START_HOUR; hour < WORK_DAY_END_HOUR; hour++) {
            const option = document.createElement("option");
            const timeString = `${String(hour).padStart(2, "0")}:00`;
            option.value = timeString;
            option.textContent = timeString;
            appointmentTimeInput.appendChild(option);
          }
        }

        function populateCarBrands() {
          carBrandSelect.innerHTML = '<option value="">Выберите марку</option>';
          for (const brand in carData) {
            const option = document.createElement("option");
            option.value = brand;
            option.textContent = brand;
            carBrandSelect.appendChild(option);
          }
        }

        function updateCarModels() {
          const selectedBrand = carBrandSelect.value;
          carModelSelect.innerHTML = '<option value="">Выберите модель</option>';
          carModelSelect.disabled = true;

          if (selectedBrand && carData[selectedBrand]) {
            const models = carData[selectedBrand];
            models.forEach((model) => {
              const option = document.createElement("option");
              option.value = model;
              option.textContent = model;
              carModelSelect.appendChild(option);
            });
            carModelSelect.disabled = false;
          }
        }

        function initializeUI() {
          appointmentDateInput.value = selectedDate;
          scheduleDateInput.value = selectedDate;
          scheduleDateInput.addEventListener("change", (e) => {
            selectedDate = e.target.value;
            renderDailySchedule();
          });
          populateTimeSelect();
          populateCarBrands();
          carBrandSelect.addEventListener("change", updateCarModels);
        }

        function renderDailySchedule() {
          dailyScheduleGrid.innerHTML = "";
          const appointmentsForDay = allAppointments.filter((app) => app.date === selectedDate);

          const header = document.createElement("div");
          header.className = "grid-header contents";
          header.innerHTML =
            `<div class="p-2 text-center font-bold border-b-2 border-gray-600">Время</div>` +
            employees
              .map((emp) => `<div class="p-2 text-center font-bold border-b-2 border-gray-600">${emp}</div>`)
              .join("");
          dailyScheduleGrid.appendChild(header);

          const coveredSlots = new Set();

          for (let hour = WORK_DAY_START_HOUR; hour < WORK_DAY_END_HOUR; hour++) {
            const timeCell = document.createElement("div");
            timeCell.className = "time-cell p-2 text-right font-semibold text-gray-400 border-r border-gray-700";
            timeCell.textContent = `${String(hour).padStart(2, "0")}:00`;
            dailyScheduleGrid.appendChild(timeCell);

            employees.forEach((employee, empIndex) => {
              const slotId = `${hour}-${empIndex}`;
              if (coveredSlots.has(slotId)) return;

              const appointment = appointmentsForDay.find((app) => {
                const appHour = parseInt(app.time.split(":")[0]);
                return app.employee === employee && appHour === hour;
              });

              const cell = document.createElement("div");

              if (appointment) {
                const duration = parseInt(appointment.duration) || 1;
                for (let i = 0; i < duration; i++) {
                  if (hour + i < WORK_DAY_END_HOUR) {
                    coveredSlots.add(`${hour + i}-${empIndex}`);
                  }
                }

                const statusClasses = {
                  Запланировано: "cell-scheduled",
                  "В работе": "cell-in-progress",
                  Завершено: "cell-completed",
                  Отменено: "cell-cancelled",
                };
                const cellStatusClass = statusClasses[appointment.status] || "bg-gray-700";

                cell.className = `employee-cell p-2 rounded-lg flex flex-col justify-between relative ${cellStatusClass}`;
                cell.style.gridRow = `span ${duration}`;
                cell.style.gridColumn = `${empIndex + 2}`;

                cell.innerHTML = `
                                <div class="text-xs overflow-hidden flex-grow">
                                    <div class="font-bold text-white truncate">${appointment.customerName}</div>
                                    <div class="text-gray-200 truncate">${appointment.carModel}</div>
                                    <div class="text-gray-300 truncate">${appointment.serviceType}</div>
                                </div>
                                <div class="mt-1">
                                    <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-black/30 block w-full text-center mb-1">${
                                      appointment.status
                                    }</span>
                                    <div class="flex gap-1 justify-center">
                                        ${
                                          appointment.status === "Запланировано"
                                            ? `<button data-id="${appointment.id}" class="btn-action-start btn btn-warning text-xs p-1 flex-grow" title="В работу">▶</button>`
                                            : ""
                                        }
                                        ${
                                          appointment.status === "В работе"
                                            ? `<button data-id="${appointment.id}" class="btn-action-complete btn btn-success text-xs p-1 flex-grow" title="Завершить">✓</button>`
                                            : ""
                                        }
                                        ${
                                          appointment.status !== "Завершено" && appointment.status !== "Отменено"
                                            ? `<button data-id="${appointment.id}" class="btn-action-cancel btn btn-danger text-xs p-1 flex-grow" title="Отменить">✕</button>`
                                            : ""
                                        }
                                    </div>
                                </div>`;
              } else {
                cell.style.gridRow = `span 1`;
                cell.style.gridColumn = `${empIndex + 2}`;
                cell.className =
                  "employee-cell p-2 rounded-lg flex items-center justify-center bg-gray-900/50 border-2 border-dashed border-gray-700 hover:bg-gray-700 transition";
                cell.innerHTML = `<button data-time="${String(hour).padStart(
                  2,
                  "0"
                )}:00" data-employee="${employee}" class="btn-action-book text-gray-500 hover:text-white text-2xl">+</button>`;
              }
              dailyScheduleGrid.appendChild(cell);
            });
          }
        }

        function listenForAppointments() {
          db.collection(APPOINTMENTS_COLLECTION).onSnapshot(
            (snapshot) => {
              allAppointments = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
              renderDailySchedule();
            },
            (error) => {
              console.error("Ошибка при получении данных Firestore:", error);
              dailyScheduleGrid.innerHTML = `<div class="col-span-full text-center p-8 text-red-400">Ошибка загрузки данных. Проверьте правила безопасности Firestore.</div>`;
            }
          );
        }

        bookingForm.addEventListener("submit", (e) => {
          e.preventDefault();
          formError.classList.add("hidden");

          const selectedTime = appointmentTimeInput.value;
          const selectedHour = parseInt(selectedTime.split(":")[0]);
          const duration = parseInt(appointmentDurationInput.value) || 1;
          const brand = carBrandSelect.value;
          const model = carModelSelect.value;

          if (selectedHour + duration > WORK_DAY_END_HOUR) {
            formError.textContent = `Ошибка: Запись выходит за рамки рабочего дня (до ${WORK_DAY_END_HOUR}:00).`;
            formError.classList.remove("hidden");
            return;
          }
          if (!brand || !model) {
            formError.textContent = "Пожалуйста, выберите марку и модель автомобиля.";
            formError.classList.remove("hidden");
            return;
          }

          const newAppointment = {
            customerName: document.getElementById("customerName").value,
            customerPhone: document.getElementById("customerPhone").value,
            carModel: `${brand} ${model}`,
            serviceType: document.getElementById("serviceType").value,
            date: appointmentDateInput.value,
            time: selectedTime,
            duration: duration,
            employee: employeeSelect.value,
            status: "Запланировано",
            createdBy: currentUserId,
          };

          db.collection(APPOINTMENTS_COLLECTION)
            .add(newAppointment)
            .then(() => {
              bookingForm.reset();
              appointmentDateInput.value = new Date().toISOString().split("T")[0];
              populateTimeSelect();
              populateCarBrands();
              updateCarModels();
            })
            .catch((error) => {
              console.error("Ошибка добавления записи: ", error);
              formError.textContent = "Не удалось добавить запись. Попробуйте снова.";
              formError.classList.remove("hidden");
            });
        });

        dailyScheduleGrid.addEventListener("click", (e) => {
          const target = e.target.closest("button");
          if (!target) return;
          const id = target.dataset.id;

          if (target.classList.contains("btn-action-cancel")) {
            showConfirmationModal("Отменить запись?", "Вы уверены?", "btn-danger", () =>
              updateAppointmentStatus(id, "Отменено")
            );
          } else if (target.classList.contains("btn-action-start")) {
            updateAppointmentStatus(id, "В работе");
          } else if (target.classList.contains("btn-action-complete")) {
            updateAppointmentStatus(id, "Завершено");
          } else if (target.classList.contains("btn-action-book")) {
            appointmentDateInput.value = selectedDate;
            appointmentTimeInput.value = target.dataset.time;
            employeeSelect.value = target.dataset.employee;
            document.getElementById("booking-form-container").scrollIntoView({ behavior: "smooth" });
            document.getElementById("customerName").focus();
          }
        });

        function updateAppointmentStatus(id, newStatus) {
          db.collection(APPOINTMENTS_COLLECTION).doc(id).update({ status: newStatus });
        }

        let confirmCallback = null;
        function showConfirmationModal(title, body, confirmClass, callback) {
          modalTitle.textContent = title;
          modalBody.textContent = body;
          modalConfirmBtn.className = `btn ${confirmClass}`;
          confirmCallback = callback;
          modal.classList.remove("hidden");
        }
        function hideModal() {
          modal.classList.add("hidden");
          confirmCallback = null;
        }
        modalCancelBtn.addEventListener("click", hideModal);
        modalConfirmBtn.addEventListener("click", () => {
          if (confirmCallback) confirmCallback();
          hideModal();
        });

        // Запускаем приложение
        initializeUI();
      });
    </script>
  </body>
</html>
